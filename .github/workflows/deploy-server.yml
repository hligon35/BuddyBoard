name: Deploy server (Docker)

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch: {}

concurrency:
  group: deploy-server
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script_stop: true
          script: |
            set -e
            cd "${{ secrets.DEPLOY_PATH }}"

            # Always match GitHub
            git fetch origin
            git checkout master || git checkout -b master origin/master
            git reset --hard origin/master
            # Keep server-local runtime config and persisted data (not committed)
            git clean -fd \
              -e .env \
              -e .env.* \
              -e .data \
              -e .data/**

            # Rebuild + restart the app/API using server-safe compose overrides
            docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build BuddyBoardApp api

            # Optional sanity check
            docker compose ps
