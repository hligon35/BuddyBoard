name: Deploy server (Docker)

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch: {}

concurrency:
  group: deploy-server
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Validate deploy secrets
        shell: bash
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          missing=0
          for v in DEPLOY_PATH; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required secret: $v"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "::error::Deploy secrets are not configured. Add them in GitHub repo settings (Settings → Secrets and variables → Actions)."
            exit 1
          fi

      - name: Deploy (self-hosted runner)
        shell: bash
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail

          cd "$DEPLOY_PATH"

          # Always match GitHub
          git fetch origin
          git checkout master || git checkout -b master origin/master
          git reset --hard origin/master
          # Keep server-local runtime config and persisted data (not committed)
          git clean -fd \
            -e .env \
            -e .env.* \
            -e .data \
            -e .data/**

          # Rebuild + restart the app/API using server-safe compose overrides
          docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build BuddyBoardApp api

          # Optional sanity check
          docker compose ps
