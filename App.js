import React, { useEffect, useState } from 'react';
import { GestureHandlerRootView } from 'react-native-gesture-handler';
import { StatusBar } from 'react-native';
import { SafeAreaProvider } from 'react-native-safe-area-context';
// Temporarily remove TailwindProvider if not available at runtime
import { NavigationContainer, createNavigationContainerRef } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';

import { AuthProvider, useAuth } from './src/AuthContext';
import { DataProvider } from './src/DataContext';
import UrgentMemoOverlay from './src/components/UrgentMemoOverlay';
import BottomNav from './src/components/BottomNav';
import DevRoleSwitcher from './src/components/DevRoleSwitcher';
import ErrorBoundary from './src/components/ErrorBoundary';
import ArrivalDetector from './src/components/ArrivalDetector';
import { logger, setDebugContext } from './src/utils/logger';
import { registerGlobalDebugHandlers } from './src/utils/registerDebugHandlers';
import { configureNotificationHandling } from './src/utils/pushNotifications';
// navigation ref used by the global bottom nav
const navigationRef = createNavigationContainerRef();

import HomeScreen from './src/screens/HomeScreen';
import ChatsScreen from './src/screens/ChatsScreen';
import ChatThreadScreen from './src/screens/ChatThreadScreen';
import NewThreadScreen from './src/screens/NewThreadScreen';
import SettingsScreen from './src/screens/SettingsScreen';
import HelpScreen from './src/screens/HelpScreen';
import MyClassScreen from './src/screens/MyClassScreen';
import AdminControlsScreen from './src/screens/AdminControlsScreen';
import StudentDirectoryScreen from './src/screens/StudentDirectoryScreen';
import FacultyDirectoryScreen from './src/screens/FacultyDirectoryScreen';
import ParentDirectoryScreen from './src/screens/ParentDirectoryScreen';
import ParentDetailScreen from './src/screens/ParentDetailScreen';
import ChildDetailScreen from './src/screens/ChildDetailScreen';
import FacultyDetailScreen from './src/screens/FacultyDetailScreen';
import ManagePermissionsScreen from './src/screens/ManagePermissionsScreen';
import PrivacyDefaultsScreen from './src/screens/PrivacyDefaultsScreen';
import ModeratePostsScreen from './src/screens/ModeratePostsScreen';
import AdminAlertsScreen from './src/screens/AdminAlertsScreen';
import AdminMemosScreen from './src/screens/AdminMemosScreen';
import ExportDataScreen from './src/screens/ExportDataScreen';
import { HelpButton, LogoutButton, BackButton } from './src/components/TopButtons';
import { View, Text } from 'react-native';
import LogoTitle from './src/components/LogoTitle';
import LoginScreen from './screens/LoginScreen';

const RootStack = createNativeStackNavigator();
const AppStack = createNativeStackNavigator();

const MyClassStackNav = createNativeStackNavigator();
function MyClassStack() {
  return (
    <MyClassStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <MyClassStackNav.Screen name="MyClassMain" component={MyClassScreen} options={{ title: 'My Class' }} />
    </MyClassStackNav.Navigator>
  );
}

const ControlsStackNav = createNativeStackNavigator();
function ControlsStack() {
  return (
    <ControlsStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <ControlsStackNav.Screen name="ControlsMain" component={AdminControlsScreen} options={{ title: 'Dashboard' }} />
      <ControlsStackNav.Screen name="StudentDirectory" component={StudentDirectoryScreen} options={{ title: 'Student Directory' }} />
      <ControlsStackNav.Screen name="FacultyDirectory" component={FacultyDirectoryScreen} options={{ title: 'Faculty Directory' }} />
      <ControlsStackNav.Screen name="ParentDirectory" component={ParentDirectoryScreen} options={{ title: 'Parent Directory' }} />
      <ControlsStackNav.Screen name="ParentDetail" component={ParentDetailScreen} options={{ title: 'Parent' }} />
      <ControlsStackNav.Screen name="ChildDetail" component={ChildDetailScreen} options={{ title: 'Student' }} />
      <ControlsStackNav.Screen name="FacultyDetail" component={FacultyDetailScreen} options={{ title: 'Faculty' }} />
      <ControlsStackNav.Screen name="AdminMemos" component={AdminMemosScreen} options={{ title: 'Compose Memo' }} />
      <ControlsStackNav.Screen name="AdminChatMonitor" component={require('./src/screens/AdminChatMonitorScreen').default} options={{ title: 'Chat Monitor' }} />
      <ControlsStackNav.Screen name="UserMonitor" component={require('./src/screens/UserMonitorScreen').default} options={{ title: 'User Monitor' }} />
      <ControlsStackNav.Screen name="ChatThread" component={ChatThreadScreen} options={{ title: 'Thread' }} />
      <ControlsStackNav.Screen name="ManagePermissions" component={ManagePermissionsScreen} options={{ title: 'Manage Permissions' }} />
      <ControlsStackNav.Screen name="PrivacyDefaults" component={PrivacyDefaultsScreen} options={{ title: 'Profile Settings' }} />
      <ControlsStackNav.Screen name="ModeratePosts" component={ModeratePostsScreen} options={{ title: 'Moderate Posts' }} />
      <ControlsStackNav.Screen name="AdminAlerts" component={AdminAlertsScreen} options={{ title: 'Alerts' }} />
      
      <ControlsStackNav.Screen name="ExportData" component={ExportDataScreen} options={{ title: 'Export Data' }} />
    </ControlsStackNav.Navigator>
  );
}

const CommunityStackNav = createNativeStackNavigator();
function CommunityStack() {
  return (
    <CommunityStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerShown: true,
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <CommunityStackNav.Screen name="CommunityMain" component={HomeScreen} options={{ title: 'Home' }} />
      <CommunityStackNav.Screen name="PostThread" component={require('./src/screens/PostThreadScreen').default} options={{ title: 'Post' }} />
    </CommunityStackNav.Navigator>
  );
}

const MyChildStackNav = createNativeStackNavigator();
function MyChildStack() {
  return (
    <MyChildStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <MyChildStackNav.Screen name="MyChildMain" component={require('./src/screens/MyChildScreen').default} options={{ title: 'My Child' }} />
    </MyChildStackNav.Navigator>
  );
}

const ChatsStackNav = createNativeStackNavigator();
function ChatsStack() {
  return (
    <ChatsStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <ChatsStackNav.Screen name="ChatsList" component={ChatsScreen} options={{ title: 'Chats' }} />
      <ChatsStackNav.Screen name="NewThread" component={NewThreadScreen} options={{ title: 'New Message' }} />
      <ChatsStackNav.Screen name="ChatThread" component={ChatThreadScreen} options={{ title: 'Thread' }} />
    </ChatsStackNav.Navigator>
  );
}

const SettingsStackNav = createNativeStackNavigator();
function SettingsStack() {
  return (
    <SettingsStackNav.Navigator
      screenOptions={({ navigation, route, back }) => ({
        headerTitleAlign: 'center',
        headerTitle: () => <LogoTitle />,
        headerLeft: () => (back ? <BackButton onPress={() => navigation.goBack()} /> : <HelpButton />),
        headerRight: () => <LogoutButton />,
      })}
    >
      <SettingsStackNav.Screen name="SettingsMain" component={SettingsScreen} options={{ title: 'Profile Settings' }} />
      <SettingsStackNav.Screen name="Help" component={HelpScreen} options={{ title: 'Help' }} />
    </SettingsStackNav.Navigator>
  );
}

// MainRoutes chooses which top-level stacks to expose based on authenticated user role.
function MainRoutes() {
  const { user } = useAuth();
  const role = (user && user.role) ? (user.role || '').toString().toLowerCase() : 'parent';

  const screens = [];
  screens.push({ name: 'Home', component: CommunityStack });
  screens.push({ name: 'Chats', component: ChatsStack });

  if (role === 'therapist') {
    screens.push({ name: 'MyClass', component: MyClassStack });
  } else if (role === 'admin' || role === 'administrator') {
    screens.push({ name: 'Controls', component: ControlsStack });
  } else {
    screens.push({ name: 'MyChild', component: MyChildStack });
  }

  screens.push({ name: 'Settings', component: SettingsStack });

  return (
    <RootStack.Navigator screenOptions={{ headerShown: false }} initialRouteName="Home">
      {screens.map(s => (
        <RootStack.Screen key={s.name} name={s.name} component={s.component} />
      ))}
    </RootStack.Navigator>
  );
}

export default function App() {
  const [problem, setProblem] = useState(null);
  const [currentRoute, setCurrentRoute] = useState('Login');

  useEffect(() => {
    try {
      configureNotificationHandling();
      registerGlobalDebugHandlers();
      logger.debug('app', 'Registered global debug handlers');
    } catch (e) {
      // ignore
    }

    const missing = [];
    if (!HomeScreen) missing.push('HomeScreen');
    if (!ChatsScreen) missing.push('ChatsScreen');
    if (!ChatThreadScreen) missing.push('ChatThreadScreen');
    if (!SettingsScreen) missing.push('SettingsScreen');
    if (!AuthProvider) missing.push('AuthProvider');
    if (!DataProvider) missing.push('DataProvider');
    if (!UrgentMemoOverlay) missing.push('UrgentMemoOverlay');
    if (missing.length) setProblem(missing);
    else setProblem(null);
    // log for Metro/console
    logger.info('app', 'App imports', {
      HomeScreen: !!HomeScreen,
      ChatsScreen: !!ChatsScreen,
      ChatThreadScreen: !!ChatThreadScreen,
      SettingsScreen: !!SettingsScreen,
      AuthProvider: !!AuthProvider,
      DataProvider: !!DataProvider,
      UrgentMemoOverlay: !!UrgentMemoOverlay,
    });
  }, []);

  if (problem && problem.length) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>
        <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 8 }}>Missing components detected</Text>
        <Text>{problem.join(', ')}</Text>
        <Text style={{ marginTop: 12, color: '#666' }}>Check the import paths and default exports for those files.</Text>
      </View>
    );
  }

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <ErrorBoundary>
      <StatusBar barStyle="dark-content" translucent={false} />
      <SafeAreaProvider>
      <AuthProvider>
        <DataProvider>
          <NavigationContainer
            ref={navigationRef}
            onStateChange={() => {
              try {
                const r = navigationRef.getCurrentRoute();
                if (r && r.name) {
                  // Map nested route names back to top-level stack keys so BottomNav highlights correctly
                  const map = {
                    Main: 'Home',
                    CommunityMain: 'Home',
                    PostThread: 'Home',
                    ChatsList: 'Chats',
                    ChatThread: 'Chats',
                    NewThread: 'Chats',
                    MyChildMain: 'MyChild',
                    SettingsMain: 'Settings',
                    MyClassMain: 'MyClass',
                    ControlsMain: 'Controls',
                  };
                  const next = map[r.name] || r.name;
                  setCurrentRoute(next);
                  setDebugContext({ route: next });
                  logger.debug('nav', 'Route change', { route: next });
                }
              } catch (e) {
                // ignore
              }
            }}
          >
            <AppStack.Navigator screenOptions={{ headerShown: false }} initialRouteName="Login">
              <AppStack.Screen name="Login">
                {(props) => <LoginScreen {...props} suppressAutoRedirect={true} />}
              </AppStack.Screen>
              <AppStack.Screen name="Main" component={MainRoutes} />
            </AppStack.Navigator>
          </NavigationContainer>
          {currentRoute !== 'Login' && (
            <>
              <BottomNav navigationRef={navigationRef} currentRoute={currentRoute} />
              <DevRoleSwitcher />
              <UrgentMemoOverlay />
              <ArrivalDetector />
            </>
          )}
        </DataProvider>
      </AuthProvider>
      </SafeAreaProvider>
      </ErrorBoundary>
    </GestureHandlerRootView>
  );
}
