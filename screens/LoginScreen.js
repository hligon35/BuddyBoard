import React, { useMemo, useState, useEffect } from 'react';
import { View, Text, TextInput, Button, StyleSheet, Alert, ActivityIndicator, TouchableOpacity, Modal, Platform, ImageBackground, KeyboardAvoidingView, ScrollView, TouchableWithoutFeedback, Keyboard } from 'react-native';
import * as LocalAuthentication from 'expo-local-authentication';
import * as SecureStore from 'expo-secure-store';
import { MaterialIcons } from '@expo/vector-icons';
import * as WebBrowser from 'expo-web-browser';
import SignUpScreen from './SignUpScreen';
import ForgotPasswordScreen from './ForgotPasswordScreen';
import { useAuth } from '../src/AuthContext';
import LogoTitle from '../src/components/LogoTitle';
import { logger } from '../src/utils/logger';
import { API_BASE_URL } from '../src/Api';
import { Sentry } from '../src/sentry';

WebBrowser.maybeCompleteAuthSession();

export default function LoginScreen({ navigation, suppressAutoRedirect = false }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [busy, setBusy] = useState(false);
  const [biometricBusy, setBiometricBusy] = useState(false);
  const [biometricAvailable, setBiometricAvailable] = useState(false);
  const [biometricLabel, setBiometricLabel] = useState('Use biometrics');
  const [hasBiometricAuthStored, setHasBiometricAuthStored] = useState(false);
  const [showSignUp, setShowSignUp] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const auth = useAuth();

  // Google sign-in is currently disabled per product decision.
  const googleEnabled = false;

  const SENTRY_OTLP_URL = 'https://o4510654674632704.ingest.us.sentry.io/api/4510654676533248/integration/otlp';
  const sentryEnv = String(process.env.EXPO_PUBLIC_SENTRY_ENVIRONMENT || '').toLowerCase();
  const sentryDsn = String(process.env.EXPO_PUBLIC_SENTRY_DSN || '');
  const showSentryTestButton = sentryEnv === 'internal';

  const fieldWidthStyle = useMemo(() => ({ width: '100%', maxWidth: 360 }), []);

  async function doLogin(){
    const cleanedEmail = String(email || '').trim();
    const cleanedPassword = String(password || '');
    if (!cleanedEmail) {
      Alert.alert('Missing email', 'Please enter your email.');
      return;
    }
    if (!cleanedPassword) {
      Alert.alert('Missing password', 'Please enter your password.');
      return;
    }

    setBusy(true);
    try{
      logger.debug('auth', 'Login submit', { hasEmail: !!cleanedEmail });
      const res = await auth.login(cleanedEmail, cleanedPassword);
      try {
        await SecureStore.setItemAsync('bb_bio_token', String(res?.token || auth?.token || ''));
        await SecureStore.setItemAsync('bb_bio_user', JSON.stringify(res?.user || auth?.user || {}));
        setHasBiometricAuthStored(true);
      } catch (e) {}
      navigation.replace('Main');
    }catch(e){
      logger.warn('auth', 'Login failed', { message: e?.message || String(e) });
      const status = e?.response?.status;
      const responseData = e?.response?.data;

      const msg = e?.message || 'Please check credentials';
      const isNetworkish = /network|timeout|ssl|certificate|ats/i.test(String(msg));
      const isBadGateway = status === 502;

      const base = API_BASE_URL || '(unset)';
      const detailLines = [];
      if (status) detailLines.push(`Status: ${status}`);
      if (base) detailLines.push(`Server: ${base}`);
      if (isBadGateway) detailLines.push('Note: 502 usually means the proxy/server could not reach the backend.');
      if (responseData != null && typeof responseData === 'string' && responseData.trim()) {
        detailLines.push(`Response: ${responseData.slice(0, 300)}`);
      } else if (responseData != null && typeof responseData === 'object') {
        try {
          detailLines.push(`Response: ${JSON.stringify(responseData).slice(0, 300)}`);
        } catch (e) {
          // ignore
        }
      }

      const detail = (isNetworkish || status) ? `\n\n${detailLines.join('\n')}` : '';
      Alert.alert('Login failed', `${msg}${detail}`);
    }finally{ setBusy(false); }
  }

  function showGoogleConfigHelp() {
    Alert.alert(
      'Google sign-in not configured',
      'Missing the Google Client ID for this platform.\n\nFor EAS builds, add these to your build profile env (or EAS project env vars):\n- EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID\n- EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID\n- EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID\n\nThen rebuild the app binary.'
    );
  }

  async function sendInternalSentryTestError() {
    try {
      if (!sentryDsn) {
        Alert.alert(
          'Sentry not configured',
          'EXPO_PUBLIC_SENTRY_DSN is empty in this build. Add it to the EAS internal environment and rebuild.'
        );
        return;
      }

      Sentry.withScope((scope) => {
        scope.setTag('bb_sentry_test', '1');
        scope.setTag('bb_env', sentryEnv || 'unknown');
        scope.setExtra('apiBaseUrl', API_BASE_URL || '');
        scope.setExtra('time', new Date().toISOString());
        Sentry.captureException(new Error('BuddyBoard Sentry test error (internal build)'));
      });

      Alert.alert('Sent', 'Sent a test error to Sentry. Check Sentry → Issues (environment: internal).');
    } catch (e) {
      Alert.alert('Failed', e?.message || 'Could not send test error.');
    }
  }

  async function doBiometricUnlock() {
    setBiometricBusy(true);
    try {
      const storedToken = await SecureStore.getItemAsync('bb_bio_token');
      const storedUser = await SecureStore.getItemAsync('bb_bio_user');
      if (!storedToken || !storedUser) {
        Alert.alert('Biometric sign-in', 'No saved sign-in found. Please sign in with email and password first.');
        return;
      }

      const result = await LocalAuthentication.authenticateAsync({
        promptMessage: 'Unlock BuddyBoard',
        cancelLabel: 'Cancel',
        disableDeviceFallback: false,
      });

      if (result?.success) {
        let parsedUser = null;
        try { parsedUser = JSON.parse(storedUser); } catch (e) {}
        await auth.setAuth({ token: storedToken, user: parsedUser || undefined });
        navigation.replace('Main');
        return;
      }

      // user_cancel / system_cancel are expected; don't throw noisy alerts
      const err = result?.error ? String(result.error) : '';
      if (err && err !== 'user_cancel' && err !== 'system_cancel' && err !== 'app_cancel') {
        Alert.alert('Biometric unlock failed', 'Please sign in with email and password.');
      }
    } catch (e) {
      Alert.alert('Biometric unlock failed', e?.message || 'Please sign in with email and password.');
    } finally {
      setBiometricBusy(false);
    }
  }

  // If already authenticated (e.g. dev auto-login), redirect to Home
  // This effect must be declared before any early returns to preserve
  // the order of Hooks between renders.
  useEffect(() => {
    if (suppressAutoRedirect) return;
    if (!auth.loading && auth.token) {
      navigation.replace('Main');
    }
  }, [auth.loading, auth.token, suppressAutoRedirect]);

  useEffect(() => {
    let mounted = true;
    (async () => {
      if (auth.loading) return;

      try {
        const hasHardware = await LocalAuthentication.hasHardwareAsync();
        const enrolled = await LocalAuthentication.isEnrolledAsync();

        let label = 'Use biometrics';
        try {
          const types = await LocalAuthentication.supportedAuthenticationTypesAsync();
          if (types.includes(LocalAuthentication.AuthenticationType.FACIAL_RECOGNITION)) label = 'Use Face ID';
          else if (types.includes(LocalAuthentication.AuthenticationType.FINGERPRINT)) label = 'Use Touch ID';
        } catch (e) {
          // ignore; default label
        }

        if (mounted) {
          setBiometricAvailable(Boolean(hasHardware && enrolled));
          setBiometricLabel(label);
        }
      } catch (e) {
        if (mounted) setBiometricAvailable(false);
      }
    })();

    return () => { mounted = false; };
  }, [auth.loading]);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const storedToken = await SecureStore.getItemAsync('bb_bio_token');
        const storedUser = await SecureStore.getItemAsync('bb_bio_user');
        if (mounted) setHasBiometricAuthStored(!!storedToken && !!storedUser);
      } catch (e) {
        if (mounted) setHasBiometricAuthStored(false);
      }
    })();
    return () => { mounted = false; };
  }, [auth.loading, showSignUp]);

  if (auth.loading) return (
    <ImageBackground
      source={require('../assets/bbbg.png')}
      resizeMode="cover"
      style={{ flex: 1, backgroundColor: '#fff' }}
      imageStyle={{ transform: [{ scale: 0.92 }] }}
    >
      <View style={styles.container}><ActivityIndicator size="large" /></View>
    </ImageBackground>
  );

  return (
    <ImageBackground
      source={require('../assets/bbbg.png')}
      resizeMode="cover"
      style={{ flex: 1, backgroundColor: '#fff' }}
      imageStyle={{ transform: [{ scale: 0.92 }] }}
    >
      <KeyboardAvoidingView
        style={{ flex: 1 }}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        keyboardVerticalOffset={0}
      >
        <TouchableWithoutFeedback onPress={Keyboard.dismiss} accessible={false}>
          <ScrollView
            contentContainerStyle={styles.container}
            keyboardShouldPersistTaps="handled"
            keyboardDismissMode="on-drag"
          >
            <View style={styles.logoWrap}>
              <LogoTitle width={450} height={135} />
            </View>
            <View style={styles.formCard}>
              <View style={fieldWidthStyle}>
                <TextInput
                  value={email}
                  onChangeText={setEmail}
                  style={styles.input}
                  placeholder="Email"
                  keyboardType="email-address"
                  autoCapitalize="none"
                />
              </View>

              <View style={[fieldWidthStyle, styles.passwordFieldWrap]}>
                <TextInput
                  value={password}
                  onChangeText={setPassword}
                  style={[styles.input, styles.passwordInput]}
                  placeholder="Password"
                  secureTextEntry={!showPassword}
                  autoCapitalize="none"
                  autoCorrect={false}
                  textContentType="password"
                />
                <TouchableOpacity
                  style={styles.peekIconBtn}
                  onPress={() => setShowPassword((v) => !v)}
                  accessibilityRole="button"
                  accessibilityLabel={showPassword ? 'Hide password' : 'Show password'}
                >
                  <MaterialIcons name={showPassword ? 'visibility-off' : 'visibility'} size={20} color="#2563eb" />
                </TouchableOpacity>
              </View>

          <View style={styles.actionsRow}>
            {showSentryTestButton ? (
              <TouchableOpacity
                onPress={sendInternalSentryTestError}
                accessibilityRole="button"
                accessibilityLabel="Internal: send Sentry test error"
                style={[styles.iconPushBtn, { marginRight: 10 }]}
                disabled={busy}
              >
                <MaterialIcons name="bug-report" size={20} color="#2563eb" />
              </TouchableOpacity>
            ) : null}

            <TouchableOpacity
              onPress={doLogin}
              accessibilityRole="button"
              accessibilityLabel="Sign in"
              style={[styles.primaryPushBtn, busy ? { opacity: 0.7 } : null]}
              disabled={busy}
              activeOpacity={0.9}
            >
              <Text style={styles.primaryPushBtnText}>{busy ? 'Signing in…' : 'Sign in'}</Text>
            </TouchableOpacity>

            {biometricAvailable && hasBiometricAuthStored ? (
              <TouchableOpacity
                onPress={doBiometricUnlock}
                accessibilityRole="button"
                accessibilityLabel={biometricLabel}
                style={[styles.iconPushBtn, { marginLeft: 10 }, (biometricBusy || busy) ? { opacity: 0.7 } : null]}
                disabled={biometricBusy || busy}
              >
                <MaterialIcons
                  name={String(biometricLabel).toLowerCase().includes('face') ? 'face' : 'fingerprint'}
                  size={22}
                  color="#2563eb"
                />
              </TouchableOpacity>
            ) : null}
          </View>

          <View style={styles.linksRow}>
            <TouchableOpacity
              onPress={() => {
                setShowForgotPassword(true);
              }}
              accessibilityRole="button"
              disabled={busy}
            >
              <Text style={styles.linkText}>Forgot password?</Text>
            </TouchableOpacity>

            <TouchableOpacity
              onPress={() => setShowSignUp(true)}
              accessibilityRole="button"
              disabled={busy}
            >
              <Text style={styles.linkText}>Register</Text>
            </TouchableOpacity>
          </View>

          <Modal visible={showSignUp} animationType="slide" onRequestClose={() => setShowSignUp(false)}>
            <SignUpScreen
              onDone={(result) => {
                setShowSignUp(false);
                if (result && result.authed) navigation.replace('Main');
              }}
              onCancel={() => setShowSignUp(false)}
            />
          </Modal>

          <Modal visible={showForgotPassword} animationType="slide" onRequestClose={() => setShowForgotPassword(false)}>
            <ForgotPasswordScreen
              onDone={() => setShowForgotPassword(false)}
              onCancel={() => setShowForgotPassword(false)}
            />
          </Modal>

          {/* Google sign-in at the bottom of the form */}
          <View style={styles.secondaryActions}>
            {/* Google sign-in disabled */}
            {googleEnabled ? null : null}

            <View style={{ width: '100%', maxWidth: 360, marginTop: 10 }}>
              <TouchableOpacity
                onPress={() => {
                  try {
                    WebBrowser.openBrowserAsync(SENTRY_OTLP_URL);
                  } catch (e) {
                    Alert.alert('Could not open link', SENTRY_OTLP_URL);
                  }
                }}
                accessibilityRole="button"
                style={styles.secondaryBtn}
              >
                <MaterialIcons name="open-in-new" size={18} color="#2563eb" />
                <Text style={styles.secondaryBtnText}>Open Sentry OTLP URL</Text>
              </TouchableOpacity>
            </View>

            {/* Internal Sentry test moved to icon button near Sign In */}
          </View>
              </View>
            </ScrollView>
          </TouchableWithoutFeedback>
        </KeyboardAvoidingView>
      </ImageBackground>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, padding: 20, justifyContent: 'center' },
  logoWrap: { alignItems: 'center', marginBottom: 18 },
  formCard: { width: '100%', maxWidth: 420, alignSelf: 'center', backgroundColor: '#fff', borderRadius: 16, padding: 16, borderWidth: 1, borderColor: '#e5e7eb' },
  title: { fontSize: 28, fontWeight: '700', marginBottom: 20 },
  input: { borderWidth: 1, borderColor: '#ccc', paddingVertical: 10, paddingHorizontal: 12, marginBottom: 12, borderRadius: 10, backgroundColor: '#fff' },
  registerWrap: { marginTop: 12, alignItems: 'center' },
  registerText: { color: '#2563eb', fontWeight: '600' },
  passwordFieldWrap: { position: 'relative' },
  passwordInput: { paddingRight: 42 },
  peekIconBtn: { position: 'absolute', right: 10, top: 10, width: 28, height: 28, alignItems: 'center', justifyContent: 'center' },
  actionsRow: { flexDirection: 'row', alignItems: 'center', justifyContent: 'center' },
  primaryPushBtn: { backgroundColor: '#2563eb', paddingVertical: 12, paddingHorizontal: 18, borderRadius: 10, minWidth: 140, alignItems: 'center' },
  primaryPushBtnText: { color: '#fff', fontWeight: '800' },
  iconPushBtn: { width: 44, height: 44, borderRadius: 10, borderWidth: 1, borderColor: '#e5e7eb', backgroundColor: '#f8fafc', alignItems: 'center', justifyContent: 'center' },
  linksRow: { marginTop: 12, width: '100%', maxWidth: 360, flexDirection: 'row', justifyContent: 'space-between', alignSelf: 'center' },
  linkText: { color: '#2563eb', fontWeight: '700' },
  secondaryActions: { marginTop: 10, alignItems: 'center' },
  secondaryBtn: { flexDirection: 'row', alignItems: 'center', justifyContent: 'center', paddingVertical: 10, paddingHorizontal: 12, borderRadius: 10, borderWidth: 1, borderColor: '#e5e7eb', backgroundColor: '#f8fafc', width: '100%', maxWidth: 360 },
  secondaryBtnText: { marginLeft: 8, color: '#111827', fontWeight: '700' },
});
