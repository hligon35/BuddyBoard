import React, { useEffect, useState } from 'react';
import { Modal, View, Text, Button, ScrollView, TouchableOpacity, StyleSheet, TouchableWithoutFeedback } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useAuth } from '../AuthContext';
import * as Api from '../Api';
import devToolsFlag from '../utils/devToolsFlag';

export default function UrgentMemoOverlay() {
  const { user } = useAuth();
  const [memos, setMemos] = useState([]);
  const [visible, setVisible] = useState(false);
  const [devToolsVisible, setDevToolsVisible] = useState(true);

  useEffect(() => {
    (async () => {
      if (!user) return;
      try {
        const data = await Api.getUrgentMemos();
        let list = Array.isArray(data) ? data : (data?.memos || []);
        if (!Array.isArray(list)) list = [];
        // Dev helper: if no memos returned in development and dev tools enabled, show a demo memo so overlay is visible for testing
        if (__DEV__ && devToolsVisible && (!Array.isArray(list) || list.length === 0)) {
          list = [
            { id: 'demo-1', title: 'Demo Urgent Memo', body: 'This is a demo urgent memo for development. Verify modal layout and acknowledgement.', date: new Date().toLocaleString() },
          ];
        }
        setMemos(list);
        const seenKey = `urgentSeen_${user.id}`;
        const seenRaw = await AsyncStorage.getItem(seenKey);
        let seen = [];
        if (seenRaw) {
          try {
            const parsed = JSON.parse(seenRaw);
            if (Array.isArray(parsed)) seen = parsed;
            else console.warn('UrgentMemoOverlay: seen key parsed but not array', parsed);
          } catch (e) {
            console.warn('UrgentMemoOverlay: failed to parse seenKey', e.message);
            seen = [];
          }
        }
        if (!Array.isArray(seen)) seen = [];
        // Defensive: ensure IDs exist before includes check
        const unseen = list.filter((m) => { try { return !seen.includes(m?.id); } catch (e) { return true; } });
        if (unseen.length) setVisible(true);
        // If there were no unseen items but we're in dev and we injected a demo memo, ensure modal shows
        if (__DEV__ && devToolsVisible && Array.isArray(list) && list.length && !visible) {
          const seenKey = `urgentSeen_${user.id}`;
          // if seen list doesn't include our demo id, show it
          try {
            const seenRaw = await AsyncStorage.getItem(seenKey);
            const parsed = seenRaw ? JSON.parse(seenRaw) : [];
            if (!Array.isArray(parsed) || !parsed.includes(list[0].id)) setVisible(true);
          } catch (e) {
            setVisible(true);
          }
        }
      } catch (e) {
        console.warn('urgent memos fetch failed', e.message);
      }
    })();
    const unsub = devToolsFlag.addListener((v) => {
      setDevToolsVisible(Boolean(v));
      if (__DEV__ && !v) setVisible(false);
    });
    (async () => {
      try {
        const v = await devToolsFlag.get();
        setDevToolsVisible(Boolean(v));
      } catch (e) {}
    })();
    return () => { try { unsub(); } catch (e) {} };
  }, [user]);

  async function handleContinue() {
    try {
      const ids = memos.map((m) => m.id);
      await Api.ackUrgentMemo(ids);
      if (user) {
        const seenKey = `urgentSeen_${user.id}`;
        await AsyncStorage.setItem(seenKey, JSON.stringify(ids));
      }
    } catch (e) {
      console.warn('ack failed', e.message);
    } finally {
      setVisible(false);
    }
  }

  return (
    <>
      <Modal visible={visible} animationType="slide" transparent>
        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center' }}>
          <TouchableWithoutFeedback onPress={() => setVisible(false)}>
            <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 }} />
          </TouchableWithoutFeedback>
          <View style={{ margin: 20, backgroundColor: 'white', borderRadius: 8, padding: 16, maxHeight: '80%' }}>
            <Text style={{ fontSize: 18, fontWeight: '600' }}>Urgent Memos</Text>
            <ScrollView style={{ marginTop: 12 }}>
              {memos.map((m) => (
                <View key={m.id} style={{ marginBottom: 12 }}>
                  <Text style={{ fontWeight: '700' }}>{m.title}</Text>
                  <Text>{m.body}</Text>
                  <Text style={{ fontSize: 12, color: '#666' }}>{m.date}</Text>
                </View>
              ))}
            </ScrollView>
            <View style={{ marginTop: 12 }}>
              <Button title="Continue" onPress={handleContinue} />
            </View>
          </View>
        </View>
      </Modal>

      {/* Dev floating button removed per request */}
    </>
  );
}

const styles = StyleSheet.create({
  // debug button removed
});
